window.__bankArea = {};
window.__bankArea.provinces = ["北京","上海","天津","重庆","河北","山西","内蒙","辽宁","吉林","黑龙江","江苏","浙江","安徽","福建","江西","山东","河南","湖北","湖南","广东","广西","海南","四川","贵州","云南","西藏","陕西","甘肃","宁夏","青海","新疆","香港","澳门","台湾"];
window.__bankArea.cities = [["东城","西城","朝阳","丰台","石景山","海淀","门头沟","房山","通州","顺义","昌平","大兴","平谷","怀柔","密云","延庆"],["黄浦","卢湾","徐汇","长宁","静安","普陀","闸北","虹口","杨浦","闵行","宝山","嘉定","浦东","金山","松江","青浦","南汇","奉贤","崇明"],["和平","东丽","河东","西青","河西","津南","南开","北辰","河北","武清","红挢","塘沽","汉沽","大港","宁河","静海","宝坻","蓟县"],["万州","涪陵","渝中","大渡口","江北","沙坪坝","九龙坡","南岸","北碚","万盛","双挢","渝北","巴南","黔江","长寿","綦江","潼南","铜梁","大足","荣昌","壁山","梁平","城口","丰都","垫江","武隆","忠县","开县","云阳","奉节","巫山","巫溪","石柱","秀山","酉阳","彭水","江津","合川","永川","南川"],["石家庄","邯郸","邢台","保定","张家口","承德","廊坊","唐山","秦皇岛","沧州","衡水"],["太原","大同","阳泉","长治","晋城","朔州","吕梁","忻州","晋中","临汾","运城"],["呼和浩特","鄂尔多斯","包头","乌海","赤峰","呼伦贝尔","阿拉善","哲里木","兴安","乌兰察布","锡林郭勒","巴彦淖尔","伊克昭"],["沈阳","大连","鞍山","抚顺","本溪","丹东","锦州","营口","阜新","辽阳","盘锦","铁岭","朝阳","葫芦岛"],["长春","吉林","四平","辽源","通化","白山","松原","白城","延边"],["哈尔滨","齐齐哈尔","牡丹江","佳木斯","大庆","绥化","鹤岗","鸡西","黑河","双鸭山","伊春","七台河","大兴安岭"],["南京","镇江","苏州","南通","扬州","盐城","徐州","连云港","常州","无锡","宿迁","泰州","淮安"],["杭州","宁波","温州","嘉兴","湖州","绍兴","金华","衢州","舟山","台州","丽水"],["合肥","芜湖","蚌埠","马鞍山","淮北","铜陵","安庆","黄山","滁州","宿州","池州","淮南","巢湖","阜阳","六安","宣城","亳州"],["福州","厦门","莆田","三明","泉州","漳州","南平","龙岩","宁德"],["南昌市","景德镇","九江","鹰潭","萍乡","新余","赣州","吉安","宜春","抚州","上饶"],["济南","青岛","淄博","枣庄","东营","烟台","潍坊","济宁","泰安","威海","日照","莱芜","临沂","德州","聊城","滨州","菏泽"],["郑州","开封","洛阳","平顶山","安阳","鹤壁","新乡","焦作","濮阳","许昌","漯河","三门峡","南阳","商丘","信阳","周口","驻马店","济源"],["武汉","宜昌","荆州","襄樊","黄石","荆门","黄冈","十堰","恩施","潜江","天门","仙桃","随州","咸宁","孝感","鄂州"],["长沙","常德","株洲","湘潭","衡阳","岳阳","邵阳","益阳","娄底","怀化","郴州","永州","湘西","张家界"],["广州","深圳","珠海","汕头","东莞","中山","佛山","韶关","江门","湛江","茂名","肇庆","惠州","梅州","汕尾","河源","阳江","清远","潮州","揭阳","云浮"],["南宁","柳州","桂林","梧州","北海","防城港","钦州","贵港","玉林","南宁地区","柳州地区","贺州","百色","河池"],["海口","三亚"],["成都","绵阳","德阳","自贡","攀枝花","广元","内江","乐山","南充","宜宾","广安","达川","雅安","眉山","甘孜","凉山","泸州","阿坝州","遂宁","巴中"],["贵阳","六盘水","遵义","安顺","铜仁","黔西南","毕节","黔东南","黔南"],["昆明","大理","曲靖","玉溪","昭通","楚雄","红河","文山","思茅","西双版纳","保山","德宏","丽江","怒江","迪庆","临沧"],["拉萨","日喀则","山南","林芝","昌都","阿里","那曲"],["西安","宝鸡","咸阳","铜川","渭南","延安","榆林","汉中","安康","商洛"],["兰州","嘉峪关","金昌","白银","天水","酒泉","张掖","武威","定西","陇南","平凉","庆阳","临夏","甘南"],["银川","石嘴山","吴忠","固原"],["西宁","海东","海南","海北","黄南","玉树","果洛","海西"],["乌鲁木齐","石河子","克拉玛依","伊犁","巴音郭勒","昌吉","克孜勒苏柯尔克孜","博尔塔拉","吐鲁番","哈密","喀什","和田","阿克苏"],["香港"],["澳门"],["台北","高雄","台中","台南","屏东","南投","云林","新竹","彰化","苗栗","嘉义","花莲","桃园","宜兰","基隆","台东","金门","马祖","澎湖"],["北美洲","南美洲","亚洲","非洲","欧洲","大洋洲","火星"]];


Dom.ready(function(){


    // 使用优惠码
    W('.use-promo-wrap').forEach(function(el, i){
        var wWrap = W(el);
        // 使用优惠码
        tcb.usePromo({
            'service_type': 2,
            'product_id': '',
            'price': 0,
            'request_params': {
                assess_key: tcb.queryUrl(window.location.search, 'assess_key')
            },
            'wWrap': wWrap,
            'succ': function(youhuiPrice, min_sale_price, wWrap){
                wWrap.query('.promoYZ').html('优惠码有效，卖出可多收'+youhuiPrice+'元').removeClass('promo-fail').addClass('promo-succ');
            },
            'fail': function(wWrap){

            }
        });
    });

    // for换新
    /*
    if( W('.pg-adding-top').length>0 && W('a[name="hx_sellinfo"]').length>0){
        var flagTop = W('a[name="hx_sellinfo"]').getRect().top - 120;

        W('.go-hx-btn').on('click', function(e){
            e.preventDefault();
            window.scrollTo(0, flagTop);
        });

        W(window).on('scroll', function(e){
            _showHXAddingBar();
        });
        W(window).on('load', function(e){
            _showHXAddingBar();
        });
        W(window).on('resize', function(e){
            _showHXAddingBar();
        });

        function _showHXAddingBar(){

            if( flagTop <= Dom.getDocRect().scrollY ){
                (W('.pg-adding-top').css('display')=='none') && W('.pg-adding-top').show();
            }else{
                (W('.pg-adding-top').css('display')!='none') && W('.pg-adding-top').hide();
            }
        }
    }*/

    if(AddrSuggest && typeof AddrSuggest=='function'){
        // 地址联想
        new AddrSuggest('[name="user_addr"]', {
            'showNum' : 6,
            'requireCity' : function(){ return W('.city-sel').html().trim(); }
        });
    }

    // 获取城市上门地区
    function getCityShangmenArea(city_name) {
        var ret = ''
        var offline_city = window._CACHE['offline_city'] || []
        tcb.each(offline_city, function (i, item) {
            if (city_name.indexOf(item['city']) > -1) {
                ret = item['tip']
            }
        })
        return ret
    }
    // 设置当前城市可用服务
    function setServiceType(huodong_show, show_offline){
        var wTabs = W('.type-select-tab .tab');

        W('.tips-shangmen-nonsupport').hide()

        // 当前城市没有支持的服务方式
        if (!(huodong_show && huodong_show.length)) {
            wTabs.removeClass('tab-selected').addClass('tab-disabled');
            W('.js-order-form-box').hide()
            W('.tips-shangmen-nonsupport').show()
            return
        }

        huodong_show = QW.ArrayH.filter(huodong_show, function(item){
            if (item!='999'){
                return true
            }
        })

        wTabs.forEach(function (el, i) {
            var wTab = W(el),
                type = parseInt(wTab.attr('data-type'), 10); // 1：上门，2：到店，3：邮寄，999：信用回收

            // //*********** 信用回收特别处理 *************
            // // 信用回收直接跳过不处理
            // if (type==999){
            //     return true
            // }
            // //*********** END信用回收特别处理 *************

            if (huodong_show.contains(type)) {
                if (type==1 && !show_offline){
                    wTab.removeClass('tab-selected').addClass('tab-disabled');
                } else {
                    wTab.removeClass('tab-selected').removeClass('tab-disabled');
                }
            } else {
                wTab.removeClass('tab-selected').addClass('tab-disabled');
            }
        });

        // 选中第一个可选的服务方式
        wTabs.filter(function(el){
            return !W(el).hasClass('tab-disabled');
        }).item(0).click();

        // 切换城市后更新图片验证码
        setTimeout(function(){
            // 更新验证码
            W('.vcode-img').fire('click')
        }, 1000)

    }
    // 设置当前城市可用服务（换新）
    function setServiceType4HX(huodong_show, show_offline){
        var wTabs = W('.type-select-tab .tab');
        wTabs.forEach(function (el, i) {
            var wTab = W(el),
                type = parseInt(wTab.attr('data-type'), 10);// 1：上门，2：到店，3：邮寄

            if (huodong_show.contains(type)) {
                if (type==1 && !show_offline){
                    wTab.removeClass('tab-selected')
                        .removeClass('tab-disabled')
                        .addClass('tab-notspt');
                } else {
                    wTab.removeClass('tab-selected')
                        .removeClass('tab-disabled')
                        .removeClass('tab-notspt');
                }
            } else {
                wTab.removeClass('tab-selected')
                    .removeClass('tab-notspt')
                    .addClass('tab-disabled');
            }
        });

        // 选中第一个可选的服务方式
        wTabs.filter(function(el){
            return !(W(el).hasClass('tab-disabled')||W(el).hasClass('tab-notspt'));
        }).item(0).click();
    }


    // 设置 到店 服务信息
    function setDaodianServiceTypeInfo(datas){
        var shop_list = datas['shop_list'] || []

        var shop_list_str = '',
            selected_shop_str = '',
            selected_shop_tel = '';
        tcb.each(shop_list, function(k, v){
            shop_list_str += '<label data-id="'+
                v['shop_id']+'" data-tel="'+
                v['shop_mobile']+'" data-addr="'+
                v['shop_name']+'（'+v['shop_addr']+'）"><input type="radio" name="shop_id" value="'+v['shop_id']+'"'+(k==0?' checked="checked"':'')+'>'+v['shop_name']+'（'+v['shop_addr']+'）</label>';
            if (k==0){
                selected_shop_str += v['shop_name']+'（'+v['shop_addr']+'）';
                selected_shop_tel = v['shop_mobile'];
            }
        });
        // 输出到店地址列表
        W('#DaoDianAddrList').html(shop_list_str);
        // 设置被选中的到店地址
        W('#HsDaodianAddr').html('下单后，请您带旧机到'+selected_shop_str+' ');
        // 设置被选中的到店电话
        W('#HsDaodianTel').html(selected_shop_tel).attr('href', 'tel:'+selected_shop_tel);
    }
    // 设置 上门 服务信息
    function setShangmenServiceTypeInfo(datas){
        // 设置上门范围区域
        var wShangmenArea = W('.dl-shangmen-area');
        if (wShangmenArea && wShangmenArea.length) {
            var area = getCityShangmenArea(datas['city_name']);

            if (area) {
                wShangmenArea.show().query('dd').html(datas['city_name']+'&nbsp;'+area);
            } else {
                wShangmenArea.hide().query('dd').html(datas['city_name']);
            }
        }

        // 设置上门客服热线
        W('#HsShangmenTel').html(datas['tel']).attr('href', 'tel:'+datas['tel']);
    }
    // 设置 邮寄 服务信息
    function setYoujiServiceTypeInfo(datas){

        // 设置邮寄客服热线
        W('#HsYouji1Tel,#HsYouji2Tel').html(datas['tel']).attr('href', 'tel:'+datas['tel']);
    }
    // 初始化城市切换相关
    function initCitySelect(selector) {
        var $selector = W(selector)
        if(!($selector && $selector.length)) return false;

        window._CACHE['cityPanel'] = Bang.AddressSelect2(selector, {
            container: '.bd-content',
            onShow: function (inst) {
                // 客户端中
                if (tcb.queryUrl(window.location.search, 'inclient')) {
                    var wSelector = W(selector),
                        rect = wSelector.getRect(),
                        wContent = W('.page-hs-client .bd-content'),
                        c_rect = wContent.getRect(),
                        scroll_top = W('.page-hs-client .bd-content')[0].scrollTop

                    inst.$dropdown.css({
                        'top': scroll_top + rect['height'] + rect['top'],
                        'left': rect['left'] - c_rect['left']
                    })
                }
            },
            onInit: function (region, inst) {
                inst.options.onConfirm(region, inst)
            },
            onConfirm: function (region, inst, noChange) {
                if (noChange) {
                    return
                }
                // 普通回收流程参数
                var hdid = '', // 活动id
                    assess_price = W('.p-b-money').attr('data-money') // 回收价格

                // 以旧换新流程参数
                if (window._CACHE['hx_flag']) {
                    hdid = window.__HD_ID
                    // 计算当前回收总价
                    assess_price = 0
                    W('.item-product-hs').forEach(function (el, i) {
                        assess_price += W(el).attr('data-price') - 0
                    })
                    assess_price = parseFloat(assess_price)
                }

                // 设置当前选择城市的服务方式
                var params = {
                    ad_province_code: region.provinceCode,
                    ad_city_code: region.cityCode,
                    ad_area_code: region.districtCode,
                    assess_price: assess_price,
                    self_enterprise: tcb.queryUrl(window.location.href, 'self_enterprise'),
                    model_id: window._CACHE['model_id'] || ''
                }
                /*活动id，在有此参数的时候才会作为参数请求*/
                if (hdid) {
                    params.hdid = hdid
                }
                var url = tcb.setUrl('/huishou/dogetshoppingtype', params)

                QW.Ajax.get(url, function (res) {
                    res = QW.JSON.parse(res)

                    if (!res['errno']) {
                        //上门回收是否填写收款信息 show_offline_payout
                        window.SHOW_OFFLINE_PAYOUT = res.result.show_offline_payout
                        if (window.SHOW_OFFLINE_PAYOUT) {
                            W('.isShowPayMethod').css('display', 'block')

                        } else {
                            W('.isShowPayMethod').css('display', 'none')
                        }
                        W(selector).siblings('.city-sel').html([region.province, region.city, region.district].join(' / '))
                        // 表单中所有城市设置为选择的城市
                        W('[name="city_name"]').val(region.city)
                        W('[name="ad_province_code"]').val(region.provinceCode)
                        W('[name="ad_city_code"]').val(region.cityCode)
                        W('[name="ad_area_code"]').val(region.districtCode)

                        var huodong_show = res['result']['huodong_show'], // 支持的服务方式
                            show_offline = res['result']['show_offline'], // 是否支持上门服务（作为支持服务方式的补充判断条件）
                            shop_list = res['result']['daodian'], // 到店店铺信息
                            tel = res['result']['def_post_info']['tel']//res['result']['tel'];

                        // 设置 上门 服务信息
                        setShangmenServiceTypeInfo({
                            'city_name': region.city,
                            'tel': tel
                        })
                        // 设置 邮寄 服务信息
                        setYoujiServiceTypeInfo({
                            'tel': tel
                        })
                        // 设置 到店 服务信息
                        setDaodianServiceTypeInfo({
                            'shop_list': shop_list
                        })

                        // 设置当前城市可用服务
                        if (window._CACHE['hx_flag']) {
                            setServiceType4HX(huodong_show, show_offline)
                        } else {
                            setServiceType(huodong_show, show_offline)
                        }

                        try { W(document).fire('myresize')} catch (ex) {}

                    } else {
                        alert('切换城市失败，请刷新页面重试')
                    }
                })
            }
        })
    }

    initCitySelect('.change-city-selector');

    var typeTipPanel;
    tcb.bindEvent(document.body, {
        // 切换回收方式
        '.type-select-tab .tab': function(e){
            e.preventDefault();

            var wMe  = W(this);

            if (wMe.hasClass('tab-disabled')) {
                return ;
            }

            // 【for换新】判断当前选择的是否为上门，且旧机总金额是否允许上门？
            var notspt = wMe.hasClass('tab-notspt');
            if(!window._CACHE['show_offline'] && notspt){
                var cart_cnt = W('.product-list .item').length,
                    show_tip = "亲，旧机抵扣价凑够200元，才能享受免费上门换新哦！",
                    btn_flag = (cart_cnt > 5) ? 1 : 0;

                var html_str = W('#jsHuishouShangmenTipsPanelTpl').html().trim().tmpl()({
                    'btn_flag': btn_flag,
                    'show_tip': show_tip
                });
                var options = {
                    className: 'hs-daodian-tips-panel-wrap'
                };
                typeTipPanel = tcb.panel('', html_str,options);

                return;
            }

            wMe.addClass('tab-selected').siblings('.tab-selected').removeClass('tab-selected');

            var wInfo = W('.js-order-form-box'),
                type = wMe.attr('data-type');

            wInfo.hide().filter('[data-type="'+type+'"]').show();

            // 【for换新】
            W('.hx-type-wrap').css({'height': 'auto'});

            // 上门
            if (type=='1'){
                W('.sm-tip').show();
                W('.yj-tip').hide();
            }
            // 邮寄
            else if (type=='3'){
                W('.sm-tip').hide();
                W('.yj-tip').show();
            }
            // 到店
            else {
                W('.sm-tip').hide();
                W('.yj-tip').hide();
            }

            var typeMap = {
                '1':'上门回收',
                '2':'到店回收',
                '3':'邮寄回收',
                '999':'信用回收'
            }
            tcb.statistic ([ '_trackEvent', 'pc回收', '回收类型', typeMap[type], '1', '' ])

            try{ W(document).fire('myresize');}catch(ex){}	//resize page happen
        },
        //在不足200元弹层中，点击再抵扣一台旧机
        '.hs-daodian-tips-panel-wrap .btn-confirm':function(e){
            e.preventDefault();
            if(typeTipPanel){
                typeTipPanel.hide();
            }

            //判断购物车是否满了
            var cart_cnt = W('.product-list .item').length;
            if(cart_cnt <= 5){
                var url_query = tcb.queryUrl(window.location.href);
                var data_params = {
                    'newproductid' : url_query['newproductid'],
                    'from' : url_query['from']
                };
                window.location.href = tcb.setUrl('/huishou', data_params);
            }
        },
        //关闭订单不足200元不上门的弹层提示
        '.hs-daodian-tips-panel-wrap .btn-cancel':function(e){
            e.preventDefault();
            if(typeTipPanel){
                typeTipPanel.hide();
            }
        },
        // 切换联系快递的方式
        '.contact-express .label': function(e){
            e.preventDefault();

            var wMe = W(this),
                val = wMe.attr('data-val');

            wMe.addClass('label-checked').siblings('.label-checked').removeClass('label-checked');

            wMe.ancestorNode('.contact-express')
                .siblings('.order-sale-form').hide().filter('[data-pos="'+val+'"]').show();

            try{ W(document).fire('myresize');}catch(ex){ }	//resize page happen
        },
        // 选择到店店铺
        '#DaoDianAddrList [name="shop_id"]': function(e){
            var $me = W(this),
                $label = $me.ancestorNode('label');

            var selected_shop_tel = $label.attr('data-tel'),
                selected_shop_str = $label.attr('data-addr');

            // 设置被选中的到店地址
            W('#HsDaodianAddr').html('下单后，请您带旧机到'+selected_shop_str+' ');
            // 设置被选中的到店电话
            W('#HsDaodianTel').html(selected_shop_tel).attr('href', 'tel:'+selected_shop_tel);
        }
    });
});


// 回收--评估结果页
Dom.ready(function(){
    var ObjPanel;

    // 绑定事件
    tcb.bindEvent(document.body, {
        '.type-select-tab .tab' : function (e) {
            //为了解决上门服务包含挑选支付方式时，在上门点击支付宝，跳回邮寄时，页面错乱的问题
            e.preventDefault ()

            if(W('.pay-via-wechat').item(1).hasClass('pay-m-curr')){
                W('.other-info-box').hide()
            }else{
                W('.other-info-box').show()
            }
            //为了解决上门服务包含挑选支付方式时，选择微信支付，还能提交订单的问题
            if(window.SHOW_OFFLINE_PAYOUT){
                if(W('.pay-via-wechat').item(0).hasClass('pay-m-curr')){
                    W('.shangmen-other-info-box').hide()
                }else{
                    W('.shangmen-other-info-box').show()
                }
            }else{
                W('.shangmen-other-info-box').show()
            }

        },
        //手机号码输入
        'form .mobile' : {
            'keyup' : function(e){
                var $me = W(this),
                    mobile = $me.val().trim();

                if (!tcb.validMobileInput(mobile)) {
                    $me.val( mobile.replace(/\D/g, '') );
                }

                // 验证是否换新活动手机号
                validHuanxin10086Mobile($me);

                //W(this).val( W(this).val().replace(/\D/g, '') );
            },
            'change' : function(e){
                var $me = W(this),
                    mobile = $me.val().trim();

                if (!tcb.validMobileInput(mobile)) {
                    $me.val( mobile.replace(/\D/g, '') );
                }

                // 验证是否换新活动手机号
                validHuanxin10086Mobile($me);

                //W(this).val( W(this).val().replace(/\D/g, '') );
            }
        },
        //银行卡号
        'form .bank-num' : {
            'keyup' : function(e){
                W(this).val( W(this).val().replace(/\D/g, '') );
            },
            'change' : function(e){
                W(this).val( W(this).val().replace(/\D/g, '') );
            }
        },
        //刷新图片验证码
        '.vcode-img' : function(e){
            e.preventDefault ()

            var $me = W(this),
                $Form = $me.ancestorNode('form'),
                src = '/secode/?rands=' + Math.random ()

            W('.vcode-img').attr('src', src).attr ('data-out-date', '')

            var $pic_secode = $Form.query ('[name="pic_secode"]')
            $pic_secode.focus ().val ('')
        },
        // 开户人名
        '.order-sale-form-v2 [name="account_holder"]' :{
            'change' : function(e){
                var wMe = W(this),
                    wForm = wMe.ancestorNode('form'),
                    wName = wForm.one('[name="saler_name"]');

                var bkname = wMe.val().trim();
                var name   = wName.val().trim();
                if( bkname!='' && name==''){
                    wName.val( bkname );
                }
            }
        },
        // 支付宝真实姓名
        '.order-sale-form-v2 [name="alipay_name"]' :{
            'change' : function(e){
                var wMe = W(this),
                    wForm = wMe.ancestorNode('form'),
                    wName = wForm.one('[name="saler_name"]');

                var apliname =wMe.val().trim();
                var name     = wName.val().trim();
                if( apliname!='' && name==''){
                    wName.val( apliname );
                }
            }
        },
        // 切换收款方式
        '.pay-m-item' : function(e){
            e.preventDefault();

            var wMe = W(this);
            wMe.addClass('pay-m-curr').siblings('.pay-m-curr').removeClass('pay-m-curr');

            var wForm = wMe.ancestorNode('form'),
                rel = wMe.attr('data-rel');
            wForm.query('.pay-info-box').hide();
            wForm.query('.pay-info-box[data-for="'+rel+'"]').show();

            if (rel=='wechat'){
                W('.other-info-box').hide()
                //为了解决上门服务包含挑选支付方式时，选择微信支付，还能提交订单的问题
                if(window.SHOW_OFFLINE_PAYOUT){
                    W('.shangmen-other-info-box').hide()
                }



                if(window.__is_huiyi){
                    W('.type-select-tab [data-type="3"] .desc span').html('专享加价25% 顺丰包邮')
                }
                else if(__is_send_redpackage && __is_youji){
                    W('.type-select-tab [data-type="3"] .desc span').html('满'+__condition_of_package+'+'+__redpackage_money)
                }else if(__is_send_redpackage){
                    W('.type-select-tab [data-type="3"] .desc span').html('+送现金红包')
                }else {
                    W('.type-select-tab [data-type="3"] .desc span').html('顺丰免费上门（全国包邮）')
                }

                if(__is_send_redpackage && __is_youji){
                    //W('.concact-box .bottom-desc').html('今日下单并寄出，加送拼手气现金红包，'+__redpackage_money+'元起！')
                    W('.concact-box .bottom-desc').show()
                }else if(__is_youji){
                    //W('.concact-box .bottom-desc').html('今日下单并寄出，满'+__condition_of_package+'元额外加送'+__redpackage_money+'元现金！')
                    W('.concact-box .bottom-desc').show()
                }else if(__is_send_redpackage){
                    //W('.concact-box .bottom-desc').html('今日下单并寄出，加送拼手气现金红包！')
                    W('.concact-box .bottom-desc').show()
                }

            } else {
                W('.other-info-box').show()
                W('.shangmen-other-info-box').show()

                if(window.__is_huiyi){
                    W('.type-select-tab [data-type="3"] .desc span').html('专享加价25% 顺丰包邮')
                }
                else if(__is_send_redpackage){
                    W('.concact-box .bottom-desc').hide()
                    //W('.concact-box .bottom-desc').html('')
                    W('.type-select-tab [data-type="3"] .desc span').html('&nbsp;')
                }else {
                    if(__is_youji){
                        W('.concact-box .bottom-desc').show()
                        //W('.concact-box .bottom-desc').html('今日下单并寄出，满'+__condition_of_package+'元额外加送'+__redpackage_money+'元现金！')
                        // W('.type-select-tab [data-type="3"] .desc span').html('满500+50')
                    }else {
                        W('.concact-box .bottom-desc').hide()
                        //W('.concact-box .bottom-desc').html('')
                        W('.type-select-tab [data-type="3"] .desc span').html('&nbsp;')
                    }

                }
            }
        },
        '.order-sale-form .insurance-check' : function(e){
            var F = W(this).parentNode('.order-sale-form');
            var name = F.one('.username').val() || '';

            if( W(this).attr('checked') ){
                F.one('.insurance-i-box').show();
                if( F.one('.insurance-name').val() == '' && name!=''){
                    F.one('.insurance-name').val(name);
                }
            }else{
                F.one('.insurance-i-box').hide();
            }
        },
        //（保存估值）二维码同步内容到微信
        '#qrcodeUpdate' : function(e){
            e.preventDefault();

            tcb.panel('', '<div style="padding:20px"><h3 style="font-size:18px;text-align:center;">同步到微信，下次一键估值</h3><img class="hs-qrupdate-pic" src="https://p.ssl.qhimg.com/t017ee3be501e423c98.gif" width="190" style="margin:10px 20px;"/></div>', {
                width:270,
                height:280,
                className: 'panel panel-tom01 border8-panel pngfix'
            });

            var assess_key = $(this).attr('data-assesskey');

            QW.Ajax.get('/huishou/aj_save_pinggu/', {'assess_key':assess_key}, function(rs){
                rs = QW.JSON.parse(rs);
                if(!rs.errno){
                    W('.hs-qrupdate-pic').attr('src', rs.result);
                }else{
                    alert("抱歉，出错了。" + rs.errmsg);
                }
            });
        },
        // 关闭窗口/换新重新填写手机号
        '.dialog-close, .huanxin-no-right-tip-wrap .btn-change-mobile': function(e){
            e.preventDefault();

            if (ObjPanel && ObjPanel.hide) {
                ObjPanel.hide();
            }
        },
        // 切换回收详情页tab
        '.hs-forms-tab .hs-f-item': function(e){
            e.preventDefault();

            var wMe = W(this),
                rel = wMe.attr('data-rel');

            var scroll_val;
            // 嵌入客户端
            if (tcb.queryUrl(window.location.search, 'inclient')){
                var wContent = W('.page-hs-client .bd-content'),
                    rel_top = W('.hs-f-content-'+rel).xy()[1],
                    tab_height = W('.hs-forms-tab').getRect()['height']-2;

                scroll_val = wContent[0].scrollTop + rel_top - tab_height;

                W('.page-hs-client .bd-content')[0].scrollTop = scroll_val;
            } else {
                scroll_val = W('.hs-f-content-'+rel).xy()[1] - W('.hs-forms-tab').getRect()['height']-2;

                tcb.gotoTop.goPlace(scroll_val);

                //tcb.setScrollTop(scroll_val);
            }
        }
    });

    // 发送手机验证码（包含普通流程+换新流程）
    W('.js-hsbtn-vcode').on('click', function(e){
        e.preventDefault();

        var sendMCodeBtn = W(this),
            wForm = sendMCodeBtn.ancestorNode('form'),
            $BtnVCode = wForm.query('.vcode-img')

        if( sendMCodeBtn.hasClass('hsbtn-vcode-dis') ){
            return;
        }

        if ($BtnVCode.attr ('data-out-date')) {
            $BtnVCode.fire ('click')
        }

        if( !validGetSmsCode (wForm) ){
            return;
        }

        var $mobile = wForm.query ('[name="tel"]'),
            $pic_secode = wForm.query ('[name="pic_secode"]'),
            $sms_type = wForm.query ('[name="sms_type"]'),
            params = {
                'mobile'     : $mobile.val ().trim (),
                'pic_secode' : $pic_secode.val ().trim (),
                'sms_type'   : $sms_type.val ().trim ()
            }
        QW.Ajax.post('/aj/doSendSmscode/', params, function(data){
            data = QW.JSON.parse(data);

            if(data.errno){
                alert(data.errmsg);

                sendMCodeBtn.removeClass ('hsbtn-vcode-dis')
                $BtnVCode.fire ('click')
            }else{
                // 当前页面所有发送手机验证码的按钮都禁止点击，加入倒计时
                var wAllSendMCodeBtn = W('.js-hsbtn-vcode');
                wAllSendMCodeBtn.addClass('hsbtn-vcode-dis').val('60秒后再次发送');
                $BtnVCode.attr ('data-out-date', '1')

                tcb.distimeAnim(60, function(time){
                    if(time<=0){
                        wAllSendMCodeBtn.removeClass('hsbtn-vcode-dis').val('发送验证码');
                    }else{
                        wAllSendMCodeBtn.val( time + '秒后再次发送');
                    }
                });
            }
        });
    })
    // 验证获取手机短信验证码表单
    function validGetSmsCode (wForm) {
        if (!(wForm && wForm.length)) {
            return false
        }
        var flag = true

        var wMobile = wForm.query ('[name="tel"]'),
            mobile_val = wMobile.val ().trim()
        if (!tcb.validMobile (mobile_val)) {
            flag = false
            wMobile.shine4Error().focus();
        }

        var wPicSecode = wForm.query ('[name="pic_secode"]'),
            pic_secode_val = wPicSecode.val ().trim()
        if (!pic_secode_val) {
            wPicSecode.shine4Error()
            if (flag) {
                wPicSecode.focus ()
            }
            flag = false
        }

        return flag
    }
    // 回收表单提交
    W('.order-sale-form-v2').on('submit', function(e){
        e.preventDefault();

        // return
        var wForm = W(this),
            form_type = wForm.attr('data-type');

        // 不同的服务表单，做不同的验证
        switch (form_type) {
            case 'shangmen':
                // 验证上门表单
                if (!validShangmenForm(wForm)) {
                    return false;
                }
                break;
            case 'daodian':
                // 验证到店表单
                if (!validDaodianForm(wForm)) {
                    return false;
                }
                break;
            case 'youji1':
            case 'youji2':
                // 验证邮寄表单
                if (form_type=='youji1') {
                    // 同城帮帮忙联系快递
                    if (!validYoujiForm1(wForm)) {
                        return false;
                    }
                } else {
                    // 自行联系快递
                    if (!validYoujiForm2(wForm)) {
                        return false;
                    }
                }
                // 收款方式为银行
                if (wForm.one('.pay-m-curr').attr('data-rel')=='bank'){
                    // 设置银行支付通道信息（支付宝无此参数）
                    var bank_name = wForm.one('[name="bank_name"]').val(),
                        bank_area = wForm.one('[name="bank_area"]').val();
                    wForm.one('[name="pay_channel"]').val( bank_name +'|'+ bank_area );
                }
                break;
        }

        if(wForm.attr('submiting')=='1'){
            return;
        }
        wForm.attr('submiting', '1');

        QW.Ajax.post('/huishou/doSubmitOrder', wForm[0], function(rs){
            try{
                rs = QW.JSON.parse(rs);
                //成功
                if(rs.errno == 0){
                    var order_id = rs.result.parent_id,
                        redirect_url = tcb.setUrl2 ('/huishou/order_succ', {
                            'order_id' : order_id
                        })

                    if (form_type.indexOf ('youji') === 0) {
                        // 邮寄回收

                        YuyueKuaidi.getGuoGuoForm(order_id, redirect_url, function (res) {

                            var html_fn = $('#JsHSSchedulePickupPanelTpl').html().trim().tmpl(),
                                html_st = html_fn ({
                                    data : {
                                        province : '',
                                        city     : res['city_name'] || window.__CITY_NAME,
                                        area_list : res['area_list']||[],
                                        mobile   : res['default_mobile'],
                                        order_id : order_id,
                                        url : redirect_url
                                    }
                                })

                            var DialogObj = tcb.showDialog (html_st, {
                                    className : 'schedule-pickup-panel',
                                    withClose : false,
                                    middle    : true//,
                                    // onClose:function () {
                                    //     window.location.href = redirect_url
                                    // }
                                })

                            // 绑定预约取件相关事件
                            YuyueKuaidi.bindEventSchedulePickup (DialogObj.wrap, redirect_url)

                        })
                    } else {
                        // 其他回收（上门、补单等）

                        window.location.href = redirect_url
                    }

                }else{
                    alert("抱歉，出错了。" + rs.errmsg)
                }
            } catch (ex){
                alert("下单异常，请刷新页面重试")
            }
            wForm.attr('submiting', '')
        })
    })

    // 验证上门表单
    function validShangmenForm(wForm) {
        if (!(wForm && wForm.length)) {
            return false;
        }

        var mobile = wForm.one('[name="tel"]'), //手机号
            mcode  = wForm.one('[name="code"]'),// 短信验证码
            server_time   = wForm.one('[name="server_time"]'), // 上门时间
            addr   = wForm.one('[name="user_addr"]'), // 用户地址
            id_card= wForm.one('[name="id_card"]'), // 身份证（某些情况需要，非必需）
            agree_protocol = wForm.one('[name="agree_protocol"]');
        //上门支持多种支付方式
        if(window.SHOW_OFFLINE_PAYOUT){
            var alipay_id   = wForm.one('[name="alipay_id"]'), //支付宝账号id
                alipay_name = wForm.one('[name="alipay_name"]'), //支付宝账号name

                bank_name = wForm.one('[name="bank_name"]'), // 开户银行
                bank_area = wForm.one('[name="bank_area"]'), // 开户地区
                bank_num = wForm.one('[name="pay_account"]'), // 开户账号
                bank_user = wForm.one('[name="account_holder"]');// 开户人姓名


            // 收款方式为-支付宝
            if(wForm.one('.pay-m-curr').item(0).attr('data-rel') == 'alipay' ){

                // 设置pay_method为支付宝：alipay
                wForm.one('[name="pay_method"]').val( 'alipay' );
                // 支付宝账号
                if( alipay_id.val().trim().length == 0 ){
                    alipay_id.shine4Error().focus();
                    return false;
                }
                // 支付宝真实姓名
                if( alipay_name.val().trim().length == 0 ){
                    alipay_name.shine4Error().focus();
                    return false;
                }
            }
            else if(wForm.one('.pay-m-curr').item(0).attr('data-rel') == 'bank'){
                // 收款方式为银行\
                var sm_bank_name=bank_name.val(),
                    sm_bank_area=bank_area.val()
                    // 设置银行支付通道信息（支付宝无此参数）
                    wForm.one('[name="pay_channel"]').val( sm_bank_name +'|'+ sm_bank_area );

                // 设置pay_method为银行：bank
                wForm.one('[name="pay_method"]').val( 'bank' );

                // 银行
                if( bank_name.val() == -1){
                    bank_name.shine4Error().focus();
                    return false;
                }
                // 开户地区
                if( bank_area.val().trim().length == 0){
                    W('.city-selector').shine4Error();
                    return false;
                }
                // 开户账号
                if( bank_num.val().trim().length == 0 ){
                    bank_num.shine4Error().focus();
                    return false;
                }
                // 开户人名
                if( bank_user.val().trim().length == 0 ){
                    bank_user.shine4Error().focus();
                    return false;
                }
            }
        }

        //手机号
        if( !tcb.validMobile(mobile.val().trim()) ){
            mobile.shine4Error().focus();
            return false;
        }
        // 手机验证码
        if (mcode && mcode.length) {
            if( mcode.val().trim().length == 0 ){
                mcode.shine4Error().focus();
                return false;
            }
        }
        // 上门时间
        if( server_time.val().trim().length == 0 ){
            server_time.shine4Error().focus();
            return false;
        }
        // 用户地址
        if( addr.val().trim().length == 0 ){
            addr.shine4Error().focus();
            return false;
        }

        // 身份证（部分活动需要）
        if (id_card && id_card.length) {
            if( !tcb.validIDCard(id_card.val().trim()) ){
                id_card.shine4Error().focus();
                return false;
            }
        }

        // 回收常见问题
        if(agree_protocol&&agree_protocol.length){
            if(!agree_protocol.attr('checked')){
                agree_protocol.ancestorNode('label').shine4Error();
                return false;
            }
        }


        return true;
    }
    // 验证到店表单
    function validDaodianForm(wForm) {
        if (!(wForm && wForm.length)) {
            return false;
        }

        var mobile = wForm.one('[name="tel"]'), //手机号
            mcode  = wForm.one('[name="code"]'),// 短信验证码
            id_card= wForm.one('[name="id_card"]'), // 身份证（某些情况需要，非必需）
            agree_protocol = wForm.one('[name="agree_protocol"]');

        //手机号
        if( !tcb.validMobile(mobile.val().trim()) ){
            mobile.shine4Error().focus();
            return false;
        }
        // 手机验证码
        if (mcode && mcode.length) {
            if( mcode.val().trim().length == 0 ){
                mcode.shine4Error().focus();
                return false;
            }
        }

        // 身份证（部分活动需要）
        if (id_card && id_card.length) {
            if( !tcb.validIDCard(id_card.val().trim()) ){
                id_card.shine4Error().focus();
                return false;
            }
        }

        // 回收常见问题
        if(agree_protocol&&agree_protocol.length){
            if(!agree_protocol.attr('checked')){
                agree_protocol.ancestorNode('label').shine4Error();
                return false;
            }
        }

        return true;
    }
    // 验证邮寄表单(由360同城帮联系快递)
    function validYoujiForm1(wForm) {
        if (!(wForm && wForm.length)) {
            return false;
        }

        var mobile = wForm.one('[name="tel"]'), //手机号
            mcode  = wForm.one('[name="code"]'),// 短信验证码
            addr   = wForm.one('[name="user_addr"]'), // 用户地址
            express_time = wForm.one('[name="express_time"]'), // 上门取件时间

            alipay_id   = wForm.one('[name="alipay_id"]'), //支付宝账号id
            alipay_name = wForm.one('[name="alipay_name"]'), //支付宝账号name

            bank_name = wForm.one('[name="bank_name"]'), // 开户银行
            bank_area = wForm.one('[name="bank_area"]'), // 开户地区
            bank_num = wForm.one('[name="pay_account"]'), // 开户账号
            bank_user = wForm.one('[name="account_holder"]'),// 开户人姓名

            pic_secode = wForm.one('[name="pic_secode"]'), // 图形验证码

            id_card= wForm.one('[name="id_card"]'), // 身份证（某些情况需要，非必需）
            agree_protocol = wForm.one('[name="agree_protocol"]');

        //手机号
        if( !tcb.validMobile(mobile.val().trim()) ){
            mobile.shine4Error().focus();
            return false;
        }
        // 手机验证码
        if (mcode && mcode.length) {
            if( mcode.val().trim().length == 0 ){
                mcode.shine4Error().focus();
                return false;
            }
        }
        // 用户地址
        if( addr.val().trim().length == 0 ){
            addr.shine4Error().focus();
            return false;
        }
        // 上门取件时间
        if( express_time.val().trim().length == 0 ){
            express_time.shine4Error().focus();
            return false;
        }

        // 收款方式为-支付宝
        if( wForm.one('.pay-m-curr').attr('data-rel') == 'alipay' ){
            // 设置pay_method为支付宝：alipay
            wForm.one('[name="pay_method"]').val( 'alipay' );

            // 支付宝账号
            if( alipay_id.val().trim().length == 0 ){
                alipay_id.shine4Error().focus();
                return false;
            }
            // 支付宝真实姓名
            if( alipay_name.val().trim().length == 0 ){
                alipay_name.shine4Error().focus();
                return false;
            }
        }
        else{
            // 设置pay_method为银行：bank
            wForm.one('[name="pay_method"]').val( 'bank' );

            // 银行
            if( bank_name.val() == -1){
                bank_name.shine4Error().focus();
                return false;
            }
            // 开户地区
            if( bank_area.val().trim().length == 0){
                W('.city-selector').shine4Error();
                return false;
            }
            // 开户账号
            if( bank_num.val().trim().length == 0 ){
                bank_num.shine4Error().focus();
                return false;
            }
            // 开户人名
            if( bank_user.val().trim().length == 0 ){
                bank_user.shine4Error().focus();
                return false;
            }
        }

        // 图形验证码
        if(pic_secode.val().trim().length == 0){
            pic_secode.shine4Error().focus();
            return false;
        }
        // 身份证（部分活动需要）
        if (id_card && id_card.length) {
            if( !tcb.validIDCard(id_card.val().trim()) ){
                id_card.shine4Error().focus();
                return false;
            }
        }
        // 回收常见问题
        if(agree_protocol&&agree_protocol.length){
            if(!agree_protocol.attr('checked')){
                agree_protocol.ancestorNode('label').shine4Error();
                return false;
            }
        }

        return true;
    }
    // 验证邮寄表单(自行联系快递)
    function validYoujiForm2(wForm) {
        if (!(wForm && wForm.length)) {
            return false;
        }

        var alipay_id   = wForm.one('[name="alipay_id"]'), //支付宝账号id
            alipay_name = wForm.one('[name="alipay_name"]'), //支付宝账号name

            bank_name = wForm.one('[name="bank_name"]'), // 开户银行
            bank_area = wForm.one('[name="bank_area"]'), // 开户地区
            bank_num = wForm.one('[name="pay_account"]'), // 开户账号
            bank_user = wForm.one('[name="account_holder"]'),// 开户人姓名

            mobile = wForm.one('[name="tel"]'), //手机号
            mcode = wForm.one('[name="code"]'), // 短信验证码
            pic_secode = wForm.one('[name="pic_secode"]'), // 图形验证码

            id_card= wForm.one('[name="id_card"]'), // 身份证（某些情况需要，非必需）
            agree_protocol = wForm.one('[name="agree_protocol"]');

        // 收款方式为-支付宝
        if( wForm.one('.pay-m-curr').attr('data-rel') == 'alipay' ){
            // 设置pay_method为支付宝：alipay
            wForm.one('[name="pay_method"]').val( 'alipay' );

            // 支付宝账号
            if( alipay_id.val().trim().length == 0 ){
                alipay_id.shine4Error().focus();
                return false;
            }
            // 支付宝真实姓名
            if( alipay_name.val().trim().length == 0 ){
                alipay_name.shine4Error().focus();
                return false;
            }
        }
        else{
            // 设置pay_method为银行：bank
            wForm.one('[name="pay_method"]').val( 'bank' );

            // 银行
            if( bank_name.val() == -1){
                bank_name.shine4Error().focus();
                return false;
            }
            // 开户地区
            if( bank_area.val().trim().length == 0){
                W('.city-selector').shine4Error();
                return false;
            }
            // 开户账号
            if( bank_num.val().trim().length == 0 ){
                bank_num.shine4Error().focus();
                return false;
            }
            // 开户人名
            if( bank_user.val().trim().length == 0 ){
                bank_user.shine4Error().focus();
                return false;
            }
        }

        //手机号
        if( !tcb.validMobile(mobile.val().trim()) ){
            mobile.shine4Error().focus();
            return false;
        }
        // 短信验证码
        if(mcode.val().trim().length == 0){
            mcode.shine4Error().focus();
            return false;
        }
        // 图形验证码
        if(pic_secode.val().trim().length == 0){
            pic_secode.shine4Error().focus();
            return false;
        }
        // 身份证（部分活动需要）
        if (id_card && id_card.length) {
            if( !tcb.validIDCard(id_card.val().trim()) ){
                id_card.shine4Error().focus();
                return false;
            }
        }
        // 回收常见问题
        if(agree_protocol&&agree_protocol.length){
            if(!agree_protocol.attr('checked')){
                agree_protocol.ancestorNode('label').shine4Error();
                return false;
            }
        }

        return true;
    }

    // 验证是否活动内手机号
    function validHuanxin10086Mobile($mobile, callback) {
        var mobile = $mobile.val().trim();
        // 10086回收换新
        if (W('body').hasClass('page-hs-hx-10086')) {
            // 输入数字位数为11+，开始验证手机号
            if (mobile.length==11) {
                if (!tcb.validMobile(mobile)) {

                    $mobile.shine4Error();

                    typeof callback==='function' && callback();
                } else {
                    if (window.__HD_ID!='1') {
                        typeof callback==='function' && callback();

                    }
                }
            } else {
                $mobile.attr('data-not2g3g', '');
                $mobile.attr('data-novalid', '');

                typeof callback==='function' && callback();
            }
        } else {
            typeof callback==='function' && callback();
        }
    }

    // 滚动条滚动时
    function scrollTab(){
        // 滚动条事件
        var wBoundary = W('.hs-new-forms'),
            wNav = W('.hs-forms-tab');
        if (wBoundary.length && wNav.length) {
            var
                wNavPlaceholder = W('.hs-forms-tab-placeholder'),
                n_height = wNav.getRect()['height']-(-8),
                boundary = [wBoundary.xy()[1]-4];

            var top_fwcn = W('.hs-f-content-fwcn').xy()[1]-n_height,
                top_comment = W('.hs-f-content-comment').xy()[1]-n_height,
                top_yinsi = W('.hs-f-content-yinsi').xy()[1]-n_height,
                top_question = W('.hs-f-content-question').xy()[1]-n_height;

            boundary.push(top_fwcn, top_comment, top_yinsi, top_question);

            var wTabItem = W('.hs-forms-tab .hs-f-item');
            /**
             * 设置顶部tab的位置
             */
            function setTopPos() {
                var s_top = tcb.getScrollTop();

                // 滚动条滚动到tab的临界位置以下
                if (s_top > boundary[0]) {
                    if (window._isIE6) {
                        wNav.css({
                            'position': 'absolute',
                            'top': s_top - boundary[0]-3
                        });
                    } else {
                        wNav.css({
                            'position': 'fixed'
                        });
                    }
                    wNavPlaceholder.show();

                } else {
                    wNav.css({
                        'position': 'static'
                    });
                    wNavPlaceholder.hide();
                }

                if (s_top<boundary[1]){
                    wTabItem.item(0).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[2]) {
                    wTabItem.item(1).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[3]) {
                    wTabItem.item(2).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[4]) {
                    wTabItem.item(3).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else{
                    wTabItem.item(4).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                }
            }
            function setTopPos2(e) {
                var s_top = e.target.scrollTop;

                // 滚动条滚动到tab的临界位置以下
                if (s_top > boundary[0]) {
                    if (window._isIE6) {
                        wNav.css({
                            'position': 'absolute',
                            'top': s_top - boundary[0]-3
                        });
                    } else {
                        wNav.css({
                            'position': 'fixed'
                        });
                    }
                    wNavPlaceholder.show();

                } else {
                    wNav.css({
                        'position': 'static'
                    });
                    wNavPlaceholder.hide();
                }

                if (s_top<boundary[1]){
                    wTabItem.item(0).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[2]) {
                    wTabItem.item(1).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[3]) {
                    wTabItem.item(2).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else if(s_top<boundary[4]) {
                    wTabItem.item(3).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                } else{
                    wTabItem.item(4).addClass('hs-f-item-curr').siblings('.hs-f-item-curr').removeClass('hs-f-item-curr');
                }
            }

            if (tcb.queryUrl(window.location.search, 'inclient')){
                //W('.page-hs-client .bd-content').on('scroll', setTopPos2);
            } else {

                W(window).on('scroll', setTopPos);
                W(window).on('load', function(){
                    var top_fwcn = W('.hs-f-content-fwcn').xy()[1]-n_height,
                        top_comment = W('.hs-f-content-comment').xy()[1]-n_height,
                        top_yinsi = W('.hs-f-content-yinsi').xy()[1]-n_height,
                        top_question = W('.hs-f-content-question').xy()[1]-n_height;

                    boundary[1] = top_fwcn;
                    boundary[2] = top_comment;
                    boundary[3] = top_yinsi;
                    boundary[4] = top_question;

                    setTopPos();
                });
                W(window).on('resize', function(){
                    var top_fwcn = W('.hs-f-content-fwcn').xy()[1]-n_height,
                        top_comment = W('.hs-f-content-comment').xy()[1]-n_height,
                        top_yinsi = W('.hs-f-content-yinsi').xy()[1]-n_height,
                        top_question = W('.hs-f-content-question').xy()[1]-n_height;

                    boundary[1] = top_fwcn;
                    boundary[2] = top_comment;
                    boundary[3] = top_yinsi;
                    boundary[4] = top_question;

                    setTopPos();
                });

                W(window).on('myresize', function(){
                    var top_fwcn = W('.hs-f-content-fwcn').xy()[1]-n_height,
                        top_comment = W('.hs-f-content-comment').xy()[1]-n_height,
                        top_yinsi = W('.hs-f-content-yinsi').xy()[1]-n_height,
                        top_question = W('.hs-f-content-question').xy()[1]-n_height;

                    boundary[1] = top_fwcn;
                    boundary[2] = top_comment;
                    boundary[3] = top_yinsi;
                    boundary[4] = top_question;

                    setTopPos();
                });

            }
        }
    }

    function init(){
        // 初始化根据滚动条变化的tab事件
        scrollTab();

        // 初始化银行地区选择
        if(W('.pay-info-box').length){
            bankAreaSelector.init( '.pay-info-box', '.bank-province-selector', '.bank-city-selector', '.bank-area', __bankArea );
        }

        // 选择取件时间
        if(W('[name="express_time"]').length){
            new DateTime('[name="express_time"]', {
                dateList : DateTime.getDateList(1, 2),
                timeList : [
                    {'text':'10:00', 'value':'10:00'},
                    {'text':'11:00', 'value':'11:00'},
                    {'text':'12:00', 'value':'12:00'},
                    {'text':'13:00', 'value':'13:00'},
                    {'text':'14:00', 'value':'14:00'},
                    {'text':'15:00', 'value':'15:00'},
                    {'text':'16:00', 'value':'16:00'},
                    {'text':'17:00', 'value':'17:00'},
                    {'text':'18:00', 'value':'18:00'}],
                onSelect : function(e){ setTimeout(function(){ W('.ele4phtips[for="form1hour_time"]').hide(); },10); }
            });
        }

        // 预约上门回收时间
        if( W('.order-sale-form-v2 [name="server_time"]').length ){
            new PlaceHolder('.order-sale-form-v2 [name="server_time"]');

            window.__ShangmenDateTime = new DateTime ('.order-sale-form-v2 [name="server_time"]', {
                remote : '/aj/doGetValidDateByRecovery',
                onSelect : function (e) { }
            });
        }

    }
    init()
})

//下单成功页
Dom.ready(function(){
    tcb.bindEvent(document.body,{
        //下单成功页 查看解锁教程
        '.show-course': function (e) {
            e.preventDefault()
            var brand_id = $(this).attr('data-brand_id')
            var course_instance = showCourse(brand_id)
            course_instance.show()
        },
        '.show-yuyue-btn': function () {
            var order_id = tcb.queryUrl(window.location.href, 'order_id'),
                redirect_url = tcb.setUrl2 ('/huishou/order_succ', {
                    'order_id' : order_id
                })

            YuyueKuaidi.getGuoGuoForm(order_id, redirect_url, function (res) {

                var html_fn = $('#JsHSSchedulePickupPanelTpl').html().trim().tmpl(),
                    html_st = html_fn ({
                        data : {
                            province : '',
                            city     : res['city_name'] || window.__CITY_NAME,
                            area_list : res['area_list']||[],
                            mobile   : res['default_mobile'],
                            order_id : order_id,
                            url : redirect_url
                        }
                    })

                var DialogObj = tcb.showDialog (html_st, {
                        className : 'schedule-pickup-panel',
                        withClose : false,
                        middle    : true//,
                        // onClose:function () {
                        //     window.location.href = redirect_url
                        // }
                    })

                // 绑定预约取件相关事件
                YuyueKuaidi.bindEventSchedulePickup (DialogObj.wrap, redirect_url)

            })
        }
    })

    //查看解锁教程
    var showCourse = (function() {
        var instance = null
        function ShowCourse(brand_name) {
            this.brand_imgs = {
                '10':'https://p0.ssl.qhmsg.com/t015b5fd8c1a532d508.png',
                '0': 'https://p0.ssl.qhmsg.com/t0187b3e1aa9261d754.png',
                '20': 'https://p1.ssl.qhmsg.com/t01457cec6f52ae6f0b.png',
                '13': 'https://p2.ssl.qhmsg.com/t0121b9870a8614e5e9.png'
            }
            this.brand_img = this.brand_imgs[brand_name]

            this.init()
        }
        ShowCourse.getInstance = function (brand_name) {
            if(!instance){
                instance = new ShowCourse(brand_name)
            }
            return instance
        }
        ShowCourse.prototype = {
            constructor: ShowCourse,
            init: function () {
                this.creatEle()
                this.bindEvent()
            },
            creatEle: function () {
                var $course_wrap = $('<div class="course-wrap"></div>')
                var inner_str = '<div class="course-inner"> <i class="icon-close"></i><div class="img-wrap"><img src="'+this.brand_img+'" alt=""></div></div>'
                $course_wrap.html(inner_str)
                $(document.body).append($course_wrap)
            },
            bindEvent: function () {
                var self = this
                $('.icon-close').on('click',function (e) {
                    e.preventDefault()
                    self.hide()
                })
                $(window).on('keydown',function (e) {
                    if(e.keyCode ==27){
                        self.hide()
                    }
                })
            },
            show: function () {
                setTimeout(function () {
                    $('.course-wrap').css({'display':'block'})
                }, 1)
            },
            hide: function () {
                $('.course-wrap').css({'display':'none'})
            },

        }
        return ShowCourse.getInstance
    })()
});


// 银行地区选择
var bankAreaSelector = (function(){
    var _area,
        _wrapBox,
        _provenceBox, Wprovence,
        _cityBox, Wcity,
        _filed, Wfiled,
        wCurPayInfoBox = null;
    function init(wrapBox, provenceBox, cityBox, filed, area){
        _area = area;

        _wrapBox = wrapBox;
        _provenceBox = provenceBox;
        Wprovence = W(provenceBox);
        _cityBox = cityBox;
        Wcity = W(cityBox);
        _filed = filed;
        Wfiled = W(filed);

        wCurPayInfoBox = Wprovence.ancestorNode(_wrapBox);

        showProvences();
        bindEvent();
    }

    function bindEvent(){
        // 切换省
        Wprovence.on('change', function(e){
            var wMe = W(this);

            wCurPayInfoBox = wMe.ancestorNode(_wrapBox);

            var p_val = wMe.val();
            if( p_val >-1 ){
                showCitys(p_val);
            }
        });
        // 切换城市
        Wcity.on('change', function(e){
            var wMe = W(this);

            wCurPayInfoBox = wMe.ancestorNode(_wrapBox);

            setFiled();
        });
    }

    function showProvences(){
        var list = _area.provinces;
        var str = '<option value="-1">所在地区</option>';
        for(var i=0, n=list.length; i<n; i++){
            str += '<option value="'+i+'">'+list[i]+'</option>';
        }

        Wprovence.html( str );
    }
    // 显示城市
    function showCitys(pid){
        var list = _area.cities[pid];

        var str = '';
        for(var i=0, n=list.length; i<n; i++){
            str += '<option value="'+i+'">'+list[i]+'</option>';
        }

        wCurPayInfoBox.query(_cityBox).show().html( str );

        setFiled();
    }

    function setFiled(){
        var province = wCurPayInfoBox.query(_provenceBox).one('option[selected]').html(),
            city = wCurPayInfoBox.query(_cityBox).one('option[selected]').html();

        wCurPayInfoBox.query(_filed).val( province +'|'+ city );
    }

    return { init: init }
})();
